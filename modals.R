# Modal Dialogs

# Modal 1: Getting started and explain left panel

createGettingStartedModal <- function() {
  bsModal(
    id = "instructionsModal1", title = "Getting Started", trigger = NULL,
    size = "large",
    tags$div(
      tags$p("Welcome to",tags$b("BrainEffeX!"),"Here's how to get started:"),
      tags$p("To facilitate the estimation and exploration of effect sizes for fMRI, we conducted “typical” study designs with large (n > 500) datasets and created a web app to share this data."),
      tags$p("Use",tags$b(tags$i("the menu to the left")),"to filter the available studies by:"),
      tags$ul(
        tags$li("Dataset"),
        tags$li("Map type (FC or activation)"), 
        tags$li("Available Tasks"),
        tags$li("Test type"),
        tags$li("Correlations (if applicable)"),
        tags$li("Motion Method"),
        tags$li("Pooling Method"),
      ),
      tags$p("Refer to the",tags$b(tags$i("tips")),"next to each input for additional guidance!"),
      tags$p("Find more details about each study, including task and measure details, on the ", tags$b(tags$i("Study Info")), " tab."),
      tags$div(style = "text-align: center;",
               actionButton("nextToPage2", "Next", style = "margin-top: 10px; background-color: #337ab7; color: white; border: none; padding: 10px 20px; font-size: 16px;")
      )
    )
  )
}

# Modal 2: Understanding the Plots

createUnderstandingPlotsModal1 <- function() {
  bsModal(
    id = "instructionsModal2", title = "Understanding the Plots", trigger = NULL,
    size = "large",
    tags$div(
      tags$p("Explore the expected effect sizes of the studies that match the provided filters."),
      tags$p(tags$b(tags$i("The plots on the left ")),"visualize all edges or voxels in each study:"),
      tags$ul(
        tags$li("Simultaneous confidence intervals (95% CI across all edges/voxels)."),
        tags$li(tags$i("Red")," indicates simultaneous CIs overlapping with 0,", tags$i("green"), "indicates no overlap."),
        tags$li(tags$i("Multivariate Effect sizes")," are displayed under the plots."),
      ),
      tags$div(style = "text-align: center;",
               actionButton("prevToPage1", "Previous", style = "margin-top: 10px; background-color: #337ab7; color: white; border: none; padding: 10px 20px; font-size: 16px;"),
               actionButton("nextToPage3", "Next", style = "margin-top: 10px; background-color: #337ab7; color: white; border: none; padding: 10px 20px; font-size: 16px;")
      )
    )
  )
}

# Modal 3: Understanding the Plots

createUnderstandingPlotsModal2 <- function() {
  bsModal(
    id = "instructionsModal3", title = "Understanding the Plots", trigger = NULL,
    size = "large",
    tags$div(
      tags$p("Explore the expected effect sizes of the studies that match the provided filters."),
      tags$p(tags$b(tags$i("The plots on the right")),"show the effect maps spatially:"),
      tags$ul(
        tags$li("Effect size matrices show the effect sizes for each edge for functional connectivity studies. Networks are labelled on the axes."),
        tags$li("Activation Maps help you visualize the effect maps from activation studies on the brain.")
      ),
      tags$div(style = "text-align: center;",
               actionButton("prevToPage2", "Previous", style = "margin-top: 10px; background-color: #337ab7; color: white; border: none; padding: 10px 20px; font-size: 16px;"),
               actionButton("nextToPage4", "Next", style = "margin-top: 10px; background-color: #337ab7; color: white; border: none; padding: 10px 20px; font-size: 16px;")
      )
    )
  )
}

createMetaAnalysisModal <- function() {
  bsModal(
    id = "instructionsModal4", title = "Meta Analysis", trigger = NULL,
    size = "large",
    tags$div(
      tags$p("The", tags$b("Meta-Analysis"), "tab shows effect sizes from meta-analyses across study categories."),
      tags$p("Meta-analyses were conducted for each category of studies using the rma.mv function in the R package metafor."),
      tags$div(style = "text-align: center;",
               actionButton("prevToPage3", "Previous", style = "margin-top: 10px; background-color: #337ab7; color: white; border: none; padding: 10px 20px; font-size: 16px;"),
               actionButton("nextToPage5", "Next", style = "margin-top: 10px; background-color: #337ab7; color: white; border: none; padding: 10px 20px; font-size: 16px;")
      )
    )
  )
}

createDownloadingEffectMapsModal <- function() {
  bsModal(
    id = "instructionsModal5", title = "Downloading Data", trigger = NULL,
    size = "large",
    tags$div(
      tags$p("How to download data from BrainEffeX:"),
      tags$ul(
        tags$li("Click the", tags$b(tags$i("'Download Data'")), "button to access the effect data stored on OSF.")
      ),
      tags$p("Use the", tags$b(tags$i("'How to Use This App'")), "button at any time to revisit these instructions."),
      tags$div(style = "text-align: center;",
               actionButton("prevToPage4", "Previous", style = "margin-top: 10px; background-color: #337ab7; color: white; border: none; padding: 10px 20px; font-size: 16px;"),
               actionButton("closePage5", "Close", style = "margin-top: 10px; background-color: #337ab7; color: white; border: none; padding: 10px 20px; font-size: 16px;")
      )
    )
  )
}


############################################

# # Function to create the dynamic panel content
createDynamicPanel <- function(input, study) {
  # Combine the reactive expression to update when either the Apply Filters or Reset Filters button is clicked
  renderUI({
    #event <- eventReactive(
    #list(input$apply_filters_btn, input$reset_btn), {  # Trigger on either button click
    messages <- c()
    
    # Dataset message
    if (is.null(input$dataset) || input$dataset == "*") {
      messages$dataset <- "• All datasets."
    } else {
      messages$dataset <- paste("• The <b>", input$dataset, "</b> dataset(s).")
    }
    
    # Map type message
    if (is.null(input$map_type) || input$map_type == "*") {
      messages$map_type <- "• All map types."
    } else {
      messages$map_type <- paste("• <b>", input$map_type, "</b> map type.")
    }
    
    # Task message
    if (is.null(input$task) || length(input$task) == 0) {
      messages$task <- "• No specific tasks are selected."
    } else if ("*" %in% input$task) {
      messages$task <- "• All tasks."
    } else {
      messages$task <- paste("• The <b>", paste(input$task, collapse = ", "), "</b> task(s).")
    }
    
    # Test type message
    if (is.null(input$test_type) || input$test_type == "*") {
      messages$test_type <- "• All test types."
    } else {
      messages$test_type <- paste("• The <b>", input$test_type, "</b> test type(s).")
    }
    
    # Correlation message
    # if (is.null(input$correlation) || length(input$correlation) == 0) {
    #   messages$correlation <- "• No specific correlations are selected."
    # } else if (length(input$correlation) == length(unique(study[["var2"]])) || input$correlation == "*") {
    #   messages$correlation <- "• All correlations"
    # } else {
    #   messages$correlation <- paste("• The <b>", paste(input$correlation, collapse = ", "), "</b> correlation(s).")
    # }
    if (is.null(input$correlation) || length(input$correlation) == 0) {
      messages$correlation <- "• No specific correlations are selected."
    } else if (length(input$correlation) == length(unique(study[["var2"]])) || "*" %in% input$correlation) {
      messages$correlation <- "• All correlations"
    } else {
      messages$correlation <- paste("• The <b>", paste(input$correlation, collapse = ", "), "</b> correlation(s).")
    }
    
    
    # Group by message
    if (!is.null(input$group_by) && input$group_by != "none") {
      messages$group_by <- paste("• The results are grouped by <b>", input$group_by, "</b>.")
    }
    
    # Combine the messages into one text
    message_text <- paste("<b>You are looking at:</b><br>", paste(messages, collapse = "<br>"))
    
    tags$div(
      style = "background-color: #f8f9fa; padding: 10px; margin-bottom: 20px; border-radius: 5px; text-align: center;",
      tags$p(HTML(message_text))
    )
  }
  )
  
  # # Render the dynamic content based on the eventReactive output
  # event()
}

# Modal event observers for navigation
createModalNavigationObservers <- function(input, session) {
  observeEvent(input$showInstructions, {
    toggleModal(session, "instructionsModal1", toggle = 'open')
  })
  
  # Page 1 -> Page 2
  observeEvent(input$nextToPage2, {
    toggleModal(session, "instructionsModal1", toggle = 'close')
    toggleModal(session, "instructionsModal2", toggle = 'open')
  })
  
  # Page 2 -> Page 1
  observeEvent(input$prevToPage1, {
    toggleModal(session, "instructionsModal2", toggle = 'close')
    toggleModal(session, "instructionsModal1", toggle = 'open')
  })
  
  # Page 2 -> Page 3
  observeEvent(input$nextToPage3, {
    toggleModal(session, "instructionsModal2", toggle = 'close')
    toggleModal(session, "instructionsModal3", toggle = 'open')
  })
  
  # Page 3 -> Page 2
  observeEvent(input$prevToPage2, {
    toggleModal(session, "instructionsModal3", toggle = "close")
    toggleModal(session, "instructionsModal2", toggle = "open")
  })
  
  # Page 3 -> Page 4 (Meta Analysis)
  observeEvent(input$nextToPage4, {
    toggleModal(session, "instructionsModal3", toggle = "close")
    toggleModal(session, "instructionsModal4", toggle = "open")
  })
  
  # Page 4 -> Page 3
  observeEvent(input$prevToPage3, {
    toggleModal(session, "instructionsModal4", toggle = "close")
    toggleModal(session, "instructionsModal3", toggle = "open")
  })
  
  # Page 4 -> Page 5 (Download Data)
  observeEvent(input$nextToPage5, {
    toggleModal(session, "instructionsModal4", toggle = "close")
    toggleModal(session, "instructionsModal5", toggle = "open")
  })
  
  # Page 5 -> Page 4
  observeEvent(input$prevToPage4, {
    toggleModal(session, "instructionsModal5", toggle = "close")
    toggleModal(session, "instructionsModal4", toggle = "open")
  })
  
  # Close from Page 5
  observeEvent(input$closePage5, {
    toggleModal(session, "instructionsModal5", toggle = "close")
  })
}